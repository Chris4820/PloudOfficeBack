{"version":3,"file":"shop.controller.js","sourceRoot":"/","sources":["modules/shop/shop.controller.ts"],"names":[],"mappings":"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","sourcesContent":["import type { NextFunction, Request, Response } from \"express\";\r\nimport { createShop, getAllUserShops, getMemberStore, getOwnerStore, getStoreById, updateScheduleStore, updateShop } from \"./shop.service\";\r\nimport { CreateShopProps, ShopTypeEnum } from \"./shop.types\";\r\nimport type { CreateShopSchemaProps } from \"./schema/shop.schema\";\r\nimport { generateShortName } from \"../../utils/utils\";\r\nimport { BadRequestException, UnauthorizedException } from \"../../commons/errors/custom.error\";\r\nimport { generateStoreJWT } from \"../../commons/jwt/store.jwt\";\r\nimport type { UpdateSettingsFormData } from \"./schema/update-shop.schema\";\r\nimport { object } from \"zod\";\r\nimport type { DayOfWeek } from \"@prisma/client\";\r\nimport type { UpdateScheduleStoreFormData } from \"./schema/update-schedule.schema\";\r\n\r\n\r\n\r\n\r\nexport async function GetAllShopsController(req: Request, res: Response, next: NextFunction) {\r\n  try {\r\n    const store = await getAllUserShops(req.userId);\r\n    return res.status(200).json(store);\r\n  } catch (error) {\r\n    next(error);\r\n  }\r\n}\r\n\r\nexport async function GetStoreInformationController(req: Request, res: Response, next: NextFunction) {\r\n  try {\r\n    const store = await getStoreById(req.storeId)\r\n    return res.status(200).json(store);\r\n  } catch (error) {\r\n    next(error);\r\n  }\r\n}\r\n\r\nexport async function CreateShopController(req: Request, res: Response, next: NextFunction) {\r\n  try {\r\n    const data = req.body as CreateShopSchemaProps;\r\n\r\n    const currentStore: CreateShopProps = {\r\n      name: data.name,\r\n      email: data.email,\r\n      address: data.address,\r\n      phone: data.phone,\r\n      shopType: data.storeType as ShopTypeEnum,\r\n      subdomain: data.subdomain,\r\n      shortName: await generateShortName(data.name),\r\n    }\r\n    await createShop(req.userId, currentStore, data.shopSchedule);\r\n    return res.status(201).json({ message: 'Loja criada com sucesso!' })\r\n  } catch (error) {\r\n    next(error)\r\n  }\r\n}\r\n\r\nexport async function OpenStoreController(req: Request, res: Response, next: NextFunction) {\r\n  try {\r\n    const storeId = Number(req.params.storeId);\r\n    if (!Number.isInteger(storeId) || storeId <= 0) {\r\n      throw new BadRequestException(\"ID da loja inválido\");\r\n    }\r\n\r\n    //Checar se tem acesso\r\n    const store = await getOwnerStore(req.userId, storeId);\r\n    if (store) {\r\n      //É dono\r\n      const token = await generateStoreJWT(storeId, true);\r\n      return res.status(200).json({\r\n        session: {\r\n          token,\r\n        }\r\n      })\r\n    }\r\n\r\n    //Verificar se é membro\r\n    const memberStore = await getMemberStore(req.userId, storeId);\r\n    if (memberStore) {\r\n      //É dono\r\n      const token = await generateStoreJWT(storeId, false);\r\n      return res.status(200).json({\r\n        session: {\r\n          token,\r\n        }\r\n      })\r\n    }\r\n    throw new UnauthorizedException(\"Você não tem permissão nesta loja\");\r\n  } catch (error) {\r\n    next(error);\r\n  }\r\n}\r\n\r\n\r\n\r\nexport async function UpdateShopController(req: Request, res: Response, next: NextFunction) {\r\n  try {\r\n    const data = req.body as UpdateSettingsFormData;\r\n    const shortName = await generateShortName(data.name);\r\n    await updateShop(req.storeId, data, shortName);\r\n    return res.status(200).json({ shortName });\r\n  } catch (error) {\r\n    next(error);\r\n  }\r\n}\r\n\r\nexport async function UpdateScheduleStoreController(req: Request, res: Response, next: NextFunction) {\r\n  try {\r\n    const data = req.body as UpdateScheduleStoreFormData;\r\n\r\n    await updateScheduleStore(req.storeId, data);\r\n\r\n    return res.status(200).json({ message: 'Ok' })\r\n\r\n  } catch (error) {\r\n    next(error)\r\n  }\r\n}"]}