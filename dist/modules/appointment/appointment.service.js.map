{"version":3,"file":"appointment.service.js","sourceRoot":"/","sources":["modules/appointment/appointment.service.ts"],"names":[],"mappings":"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","sourcesContent":["import type { AppointmentStatus } from \"@prisma/client\";\r\nimport prisma from \"../../libs/prisma\";\r\nimport type { CreateEventFormData } from \"../calendar/schema/create-appointment\";\r\nimport type { AppointmentType } from \"../calendar/types/appointment.type\";\r\nimport type { EditEventFormData } from \"./schema/update.schema\";\r\n\r\n\r\nexport async function createBooking(\r\n  start: Date,\r\n  end: Date,\r\n  shopId: number,\r\n  collabId: number,\r\n  clientId: number,\r\n  duration: number,\r\n  serviceId: number,\r\n  price: number,\r\n) {\r\n  return await prisma.appointment.create({\r\n    data: {\r\n      start: start,\r\n      shopId,\r\n      collaboratorId: collabId,\r\n      clientId,\r\n      end: end,\r\n      duration,\r\n      price,\r\n      serviceId,\r\n    },\r\n    select: {\r\n      uuid: true,\r\n    }\r\n  })\r\n}\r\n\r\nexport async function CreateAppointment(storeId: number, data: AppointmentType, dataProps: CreateEventFormData) {\r\n  return await prisma.appointment.create({\r\n    data: {\r\n      Shop: {\r\n        connect: {\r\n          id: storeId\r\n        }\r\n      },\r\n      User: {\r\n        connect: {\r\n          id: data.collabId\r\n        }\r\n      },\r\n      Client: {\r\n        connectOrCreate: {\r\n          where: {\r\n            shopId_email: {\r\n              shopId: storeId,\r\n              email: dataProps.Client.email,\r\n            },\r\n          },\r\n          create: {\r\n            name: dataProps.Client.name,\r\n            email: dataProps.Client.email,\r\n            notes: dataProps.Client.notes,\r\n            updatedAt: new Date(),\r\n            Shop: {\r\n              connect: {\r\n                id: storeId\r\n              }\r\n            }\r\n          }\r\n        }\r\n      },\r\n      Service: {\r\n        connect: {\r\n          id: data.serviceId,\r\n        }\r\n      },\r\n      end: data.end,\r\n      price: 15,\r\n      duration: data.duration,\r\n      start: data.start,\r\n    },\r\n    select: {\r\n      uuid: true,\r\n      Client: {\r\n        select: {\r\n          id: true,\r\n          name: true,\r\n          email: true,\r\n        }\r\n\r\n      }\r\n    }\r\n  });\r\n}\r\n\r\n\r\nexport async function getAppointmentClient(clientId: number, shopId: number) {\r\n  return await prisma.appointment.findMany({\r\n    where: {\r\n      shopId,\r\n      clientId,\r\n    },\r\n    select: {\r\n      id: true,\r\n      start: true,\r\n      duration: true,\r\n      price: true,\r\n      createdAt: true,\r\n      User: {\r\n        select: {\r\n          id: true,\r\n          name: true,\r\n        }\r\n      }\r\n    },\r\n    take: 5,\r\n  })\r\n}\r\n\r\nexport async function getAppointmentById(appointmentId: number, shopId: number) {\r\n  return await prisma.appointment.findUnique({\r\n    where: {\r\n      shopId,\r\n      id: appointmentId,\r\n    },\r\n    select: {\r\n      id: true,\r\n      notes: true,\r\n      status: true,\r\n      Client: {\r\n        select: {\r\n          id: true,\r\n          name: true,\r\n          notes: true,\r\n          email: true,\r\n          phone: true,\r\n        }\r\n      },\r\n      Service: {\r\n        select: {\r\n          id: true,\r\n          name: true,\r\n        }\r\n      },\r\n      start: true,\r\n      duration: true,\r\n      price: true,\r\n      createdAt: true,\r\n      User: {\r\n        select: {\r\n          id: true,\r\n          name: true,\r\n        }\r\n      }\r\n    },\r\n  })\r\n}\r\n\r\nexport async function updateAppointmentStatus(appointmentId: number, storeId: number, status: AppointmentStatus) {\r\n  return await prisma.appointment.update({\r\n    where: {\r\n      id: appointmentId,\r\n      shopId: storeId,\r\n    },\r\n    data: {\r\n      status,\r\n    }\r\n  })\r\n}\r\n\r\nexport async function deleteAppointment(appointmentId: number, storeId: number) {\r\n  return await prisma.appointment.delete({\r\n    where: {\r\n      id: appointmentId,\r\n      shopId: storeId\r\n    }\r\n  })\r\n}\r\n\r\nexport async function updateAppointment(appoinmentId: number, storeId: number, data: EditEventFormData, endDate: Date) {\r\n  return await prisma.appointment.update({\r\n    where: {\r\n      id: appoinmentId,\r\n      shopId: storeId,\r\n    },\r\n    data: {\r\n      serviceId: data.serviceId,\r\n      collaboratorId: data.collabId,\r\n      start: data.start,\r\n      end: endDate,\r\n      duration: data.duration,\r\n    },\r\n  })\r\n}"]}